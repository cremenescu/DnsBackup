# generate_zones_csv.ps1
# Scanează fișierele .dns + registry pentru a genera zones.csv compatibil cu scriptul de restaurare DNS

$dnsPath = "C:\Windows\System32\dns"
$zonesKey = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\DNS Server\Zones"
$outputCsv = "C:\DNS-zones-generated.csv"

if (-not (Test-Path $dnsPath)) {
    Write-Host "Folderul $dnsPath nu există!" -ForegroundColor Red
    exit
}

$dnsFiles = Get-ChildItem -Path $dnsPath -Filter "*.dns" | Where-Object { $_.BaseName -notin @("cache", "TrustAnchors") }
$zoneList = @()

foreach ($file in $dnsFiles) {
    $zoneName = $file.BaseName
    $fileName = $file.Name
    $zoneType = "Primary"
    $masters = ""

    $zoneReg = Join-Path $zonesKey $zoneName
    if (Test-Path $zoneReg) {
        $props = Get-ItemProperty -Path $zoneReg -ErrorAction SilentlyContinue
        if ($props.ZoneType -eq 1) {
            $zoneType = "Secondary"
            $masters = ($props.MasterServers -join ",")
        } elseif ($props.ZoneType -eq 2) {
            $zoneType = "Stub"
        }
    }

    $zoneList += [PSCustomObject]@{
        ZoneName  = $zoneName
        FileName  = $fileName
        ZoneType  = $zoneType
        MasterIPs = $masters
    }
}

$zoneList | Export-Csv -Path $outputCsv -NoTypeInformation -Encoding UTF8
Write-Host "zones.csv generat: $outputCsv" -ForegroundColor Green
